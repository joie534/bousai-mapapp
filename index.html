<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="viewport"
        content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>防犯マップ</title>

    <link rel="manifest" href="./manifest.json">
    <meta name="theme-color" content="#ffffff">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <link rel="apple-touch-icon" href="./icon-180.png">

    <script src="https://unpkg.com/maplibre-gl@4.1.2/dist/maplibre-gl.js"></script>
    <link href="https://unpkg.com/maplibre-gl@4.1.2/dist/maplibre-gl.css" rel="stylesheet" />
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <style>
        * {
            box-sizing: border-box;
        }

        html,
        body {
            margin: 0 !important;
            padding: 0 !important;
            width: 100%;
            height: 100%;
            overflow: hidden;
            background-color: #ffffff;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            overscroll-behavior: none;
        }



        #map {
            position: fixed !important;
            top: 0 !important;
            left: 0 !important;
            width: 100%;
            height: 100%;
            z-index: 0;
        }

        /* フッターナビゲーション */
        .footer-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            z-index: 10;
            background-color: rgba(255, 255, 255, 0.96);
            padding: 0;
            padding-top: 8px;
            padding-bottom: 8px;
            /* Safari用 */
            display: flex;
            justify-content: space-around;
            align-items: center;
            box-shadow: 0 -1px 5px rgba(0, 0, 0, 0.1);
        }

        /* PWAモード時は下余白0 */
        @media (display-mode: standalone) {
            .footer-nav {
                padding-bottom: 0;
            }
        }

        .nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: #666666;
            font-size: 10px;
            line-height: 1;
            text-decoration: none;
            width: 100%;
            padding: 0;
            margin: 0;
            cursor: pointer;
            -webkit-tap-highlight-color: transparent;
        }

        .nav-item svg {
            width: 24px;
            height: 24px;
            margin-bottom: 8px;
            fill: #666666;
        }

        /* フローティング投稿ボタン（右下） */
        #floating-post-btn {
            position: fixed;
            bottom: 90px;
            right: 20px;
            z-index: 100;
            cursor: pointer;
            -webkit-tap-highlight-color: transparent;
        }

        #floating-post-btn .circle {
            width: 60px;
            height: 60px;
            background: linear-gradient(135deg, #FF0055, #FF3366);
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            box-shadow: 0 4px 15px rgba(255, 0, 85, 0.4);
        }

        #floating-post-btn svg {
            width: 30px;
            height: 30px;
            fill: white;
        }


        /* クロスヘア */
        #crosshair {
            position: fixed;
            top: 50%;
            left: 50%;
            width: 20px;
            height: 20px;
            transform: translate(-50%, -50%);
            pointer-events: none;
            z-index: 5;
        }

        #crosshair::before,
        #crosshair::after {
            content: '';
            position: absolute;
            background: #fff;
            box-shadow: 0 0 2px #000;
        }

        #crosshair::before {
            top: 9px;
            left: 0;
            width: 20px;
            height: 2px;
        }

        #crosshair::after {
            top: 0;
            left: 9px;
            width: 2px;
            height: 20px;
        }

        /* コントロール位置 */
        .maplibregl-ctrl-top-right {
            top: 50px;
            right: 10px;
        }

        .maplibregl-ctrl-bottom-left {
            bottom: 80px;
            /* フッターの上 */
            left: 10px;
        }
    </style>
</head>

<body>
    <div id="map"></div>
    <div id="crosshair"></div>

    <!-- フローティング投稿ボタン -->
    <div id="floating-post-btn">
        <div class="circle">
            <svg viewBox="0 0 24 24">
                <path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z" />
            </svg>
        </div>
    </div>

    <div class="footer-nav">
        <div class="nav-item" id="nav-home">
            <svg viewBox="0 0 24 24">
                <path d="M10 20v-6h4v6h5v-8h3L12 3 2 12h3v8z" />
            </svg>
            <span>ホーム</span>
        </div>
        <div class="nav-item" id="nav-list">
            <svg viewBox="0 0 24 24">
                <path
                    d="M4 10.5c-.83 0-1.5.67-1.5 1.5s.67 1.5 1.5 1.5 1.5-.67 1.5-1.5-.67-1.5-1.5-1.5zm0-6c-.83 0-1.5.67-1.5 1.5S3.17 7.5 4 7.5 5.5 6.83 5.5 6 4.83 4.5 4 4.5zm0 12c-.83 0-1.5.68-1.5 1.5s.68 1.5 1.5 1.5 1.5-.68 1.5-1.5-.67-1.5-1.5-1.5zM7 19h14v-2H7v2zm0-6h14v-2H7v2zm0-8v2h14V5H7z" />
            </svg>
            <span>リスト</span>
        </div>

        <div class="nav-item" id="nav-search">
            <svg viewBox="0 0 24 24">
                <path
                    d="M15.5 14h-.79l-.28-.27C15.41 12.59 16 11.11 16 9.5 16 5.91 13.09 3 9.5 3S3 5.91 3 9.5 5.91 16 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z" />
            </svg>
            <span>検索</span>
        </div>
        <div class="nav-item" id="nav-settings">
            <svg viewBox="0 0 24 24">
                <path
                    d="M19.14 12.94c.04-.3.06-.61.06-.94 0-.32-.02-.64-.07-.94l2.03-1.58c.18-.14.23-.41.12-.61l-1.92-3.32c-.12-.22-.37-.29-.59-.22l-2.39.96c-.5-.38-1.03-.7-1.62-.94L14.4 2.81c-.04-.24-.24-.41-.48-.41h-3.84c-.24 0-.43.17-.47.41l-.36 2.54c-.59.24-1.13.57-1.62.94l-2.39-.96c-.22-.08-.47 0-.59.22L2.74 8.87c-.12.21-.08.47.12.61l2.03 1.58c-.05.3-.09.63-.09.94s.02.64.07.94l-2.03 1.58c-.18.14-.23.41-.12.61l1.92 3.32c.12.22.37.29.59.22l2.39-.96c.5.38 1.03.7 1.62.94l.36 2.54c.05.24.24.41.48.41h3.84c.24 0 .44-.17.47-.41l.36-2.54c.59-.24 1.13-.56 1.62-.94l2.39.96c.22.08.47 0 .59-.22l1.92-3.32c.12-.22.07-.47-.12-.61l-2.01-1.58zM12 15.6c-1.98 0-3.6-1.62-3.6-3.6s1.62-3.6 3.6-3.6 3.6 1.62 3.6 3.6-1.62 3.6-3.6 3.6z" />
            </svg>
            <span>設定</span>
        </div>
    </div>

    <script>
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', function () {
                navigator.serviceWorker.register('./service-worker.js');
            });
        }

        const SUPABASE_URL = 'https://aflahjkzuozhptawwxlu.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImFmbGFoamt6dW96aHB0YXd3eGx1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjM3MDk1MTAsImV4cCI6MjA3OTI4NTUxMH0.n_XnS3eFC2yqhjfjKcfA55K1BupzXh0lpAYv95N3dew';
        const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        const MAPTILER_KEY = 'UbOOOjdSN26zP8niTJvU';
        const STYLE_URL = `https://api.maptiler.com/maps/streets-v2/style.json?key=${MAPTILER_KEY}`;

        const map = new maplibregl.Map({
            container: 'map',
            style: STYLE_URL,
            center: [139.633, 35.537],
            zoom: 16,
            maxZoom: 22,
            minZoom: 4,
            pitch: 0,
            attributionControl: false,
            maxBounds: [[139.50, 35.45], [139.68, 35.60]]
        });

        map.addControl(new maplibregl.AttributionControl({ compact: true }), 'bottom-left');

        // GPS
        const geolocateControl = new maplibregl.GeolocateControl({
            positionOptions: { enableHighAccuracy: true },
            trackUserLocation: true,
            showUserHeading: true
        });
        map.addControl(geolocateControl, 'top-right');

        map.on('load', async () => {
            loadPins();
            map.addSource('force-3d-source', {
                url: `https://api.maptiler.com/tiles/v3/tiles.json?key=${MAPTILER_KEY}`,
                type: 'vector'
            });

            const layers = map.getStyle().layers;
            let labelLayerId;
            for (let i = 0; i < layers.length; i++) {
                if (layers[i].type === 'symbol' && layers[i].layout['text-field']) {
                    labelLayerId = layers[i].id;
                    break;
                }
            }
            map.addLayer({
                'id': '3d-buildings-forced',
                'source': 'force-3d-source',
                'source-layer': 'building',
                'filter': ['==', 'extrude', 'true'],
                'type': 'fill-extrusion',
                'minzoom': 15,
                'paint': {
                    'fill-extrusion-color': '#dddddd', // 建物の色（ライトグレー）
                    'fill-extrusion-height': [
                        "interpolate", ["linear"], ["zoom"],
                        15, 0,
                        15.05, ["get", "height"]
                    ],
                    'fill-extrusion-base': [
                        "interpolate", ["linear"], ["zoom"],
                        15, 0,
                        15.05, ["get", "min_height"]
                    ],
                    'fill-extrusion-opacity': 0.7 // 不透明度
                }
            }, labelLayerId);
        });

        async function loadPins() {
            const { data, error } = await supabaseClient.from('pins').select('*');
            if (data) { data.forEach(pin => addPinToMap(pin)); }
        }

        function addPinToMap(pinData) {
            new maplibregl.Marker({ color: "#FF0055" })
                .setLngLat([pinData.lng, pinData.lat])
                .setPopup(new maplibregl.Popup().setText(pinData.message))
                .addTo(map);
        }

        document.getElementById('floating-post-btn').addEventListener('click', async () => {
            const center = map.getCenter();
            const lng = center.lng;
            const lat = center.lat;
            const message = prompt("不審者情報を入力してください");
            if (message) {
                const { error } = await supabaseClient
                    .from('pins').insert([{ lat, lng, message }]);
                if (!error) {
                    addPinToMap({ lat, lng, message });
                    alert("投稿しました！");
                } else {
                    alert("エラーが発生しました");
                }
            }
        });
    </script>
</body>

</html>